#!/usr/bin/env perl
#
# (c) Juergen Brunk <juergen.brunk.de@googlemail.com>
# 
# vim: set ts=3 sw=3 tw=0:
# vim: set expandtab:

use strict;
use warnings;
use File::Basename;

our $VERSION = "0.10";

#======================================================================

$|++;	# autoflushing

sub d_print 
{
	my ($msg) = join("", @_);

	print STDERR "[DEBUG] $msg\n" if (defined($ENV{'DEBUG'}));
}

MAIN:
{
	my ($real_name, $mode, $real_dir, $cmd, $symlink);

	#system("logger -t fooboo \"invoking $0 with @ARGV\"");
	#open OUT, ">>/tmp/fooboo.log"; print OUT scalar localtime, ": invoking $0 with @ARGV\n"; close OUT;

	d_print "Program Name \$0 = $0";

	if ( -l $0 && $0 =~ /\/etc\// )		# called by symlink?
	{
		$real_name = readlink $0;	# get real name
		d_print "#1 Symlink $0 -> $real_name";

		if ( -l $real_name && $real_name =~ /\/init.d\// )	# also a symlink? (2nd stage)
		{
			d_print "#2 Symlink $real_name -> ", readlink $real_name;
			$real_name = readlink $real_name;	
		}

		$mode = shift || die "Please provide an argument, eg. <start|stop>";

		d_print "Mode = $mode";
		$real_dir = dirname($real_name);
		d_print "Instance Dir = $real_dir";
		$cmd = "$real_dir/$mode";
		d_print "Exec: $cmd";
		exec($cmd) or die "Can't exec \"$cmd\": $!";
	}

	else
	{
		print <<EOT;

Please invoke this Script by Symlinks, eg:

/opt/sc/memcache/instance1/init -> /usr/local/bin/sc_init
/etc/init.d/memcache_instance1 -> /opt/sc/memcache/instance1/init
/etc/rc2.d/S90memcache_instance1 -> /etc/init.d/memcache_instance1

or simple use the "sc_updaterc" tool ;-)

EOT
	}

	exit(0);
}


__END__

=head1 NAME

sc_init - Runlevel Wrapper for ServerControl Instances.

=head1 AUTHOR

Juergen Brunk <juergen.brunk.de@googlemail.com>

=head1 DESCRIPTION

sc_init will by invoked by Runlevel Symlinks:

for Example:

 /opt/sc/memcache/instance1/init -> /usr/local/bin/sc_init
 /etc/init.d/memcache_instance1 -> /opt/sc/memcache/instance1/init
 /etc/rc2.d/S90memcache_instance1 -> /etc/init.d/memcache_instance1

Start/Stop Services:

 /etc/init.d/memcache_instance1 start
 /etc/init.d/memcache_instance1 stop

Please use the "sc_updaterc" Tool for setting/removing the Runlevel Symlink.

=head1 BUGS

 o only tested with Debian 6.x Squeeze
 o Pathnames to /opt/sc/ mandatory and hardcoded

=cut

